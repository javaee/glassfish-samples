<?xml version="1.0" encoding="UTF-8"?>

<!-- Copyright 1997-2007 Sun Microsystems, Inc. All rights reserved.-->

<project name="glassfish-samples" default="all" basedir="." xmlns:artifact="urn:maven-artifact-ant">
    <description>Builds, tests, and packages the project glassfish-samples.</description>

    <import file="bp-project/main.xml"/>

    <property file="bp-project/test.properties"/>
    <property file="javaee6_samples.properties"/>

    <property name="dist.dir" value="dist"/>
    <property name="test.results.dir" value="test-results"/>

    <target name="init-dist">
        <delete dir="${dist.dir}"/>
        <mkdir dir="${dist.dir}"/>
    </target>

    <target name="init-test">
        <delete dir="${test.results.dir}"/>
        <mkdir dir="${test.results.dir}"/>
    </target>

    <patternset id="bp.project.contents"
        includes="bp-project/**"
        excludes="build.xml,bp-project/test.xml,bp-project/build.properties,bp-project/build.properties.xyz,bp-project/test.properties"
    />

    <patternset id="web.profile.contents"
        includes="javaee6/index.html, javaee6/docs/UserREADME.html, javaee6/docs/UserTroubleShooting.html, javaee6/docs/list.html, javaee6/docs/JavaDB.html, javaee6/docs/javadb-setup/**,
                  javaee6/jpa/**, javaee6/ejb/ejb31-war/**, javaee6/web/servlet/**, javaee6/web/jsf/**, javaee6/security/**, javaee6/webbeans/**"
        excludes="javaee6/**/test/**"/>

    <patternset id="classic.profile.contents"
        includes="javaee6/index.html, javaee6/docs/Components.js, javaee6/docs/UserREADME.html, javaee6/docs/UserTroubleShooting.html, javaee6/docs/list.html, javaee6/docs/JavaDB.html, javaee6/docs/javadb-setup/**,
                  javaee6/ejb/automatic-timer/**, javaee6/rest/message-board-war/**, javaee6/webservices/**, javaee6/connectors/apps/mailconnector/**"
        excludes="javaee6/**/test/**"/>

    <!-- TODO: use bp, web and classic contents -->
    <patternset id="include.sdk.contents"
        includes="bp-project/**, docs/**, index.html, javaee6/build.xml, javaee6/docs/**, javaee6/index.html, javaee6/LICENSE, javaee6/connectors/apps/mailconnector/mailconnector-ear/**, javaee6/connectors/apps/mailconnector/mailconnector-ra/**, javaee6/ejb/automatic-timer/**, javaee6/ejb/ejb31-war/**, javaee6/ejb/hello-stateless-ejb/**, javaee6/jpa/locking/**, javaee6/rest/message-board-war/**, javaee6/security/http-method-omission/**, javaee6/security/programmatic-login/**, javaee6/security/web-security-annotation/**, javaee6/web/jsf/basic-ajax/**, javaee6/web/jsf/basic-ezcomp/**, javaee6/web/servlet/annotation-war/**, javaee6/web/servlet/async-request-war/**, javaee6/web/servlet/dynamicregistration-war/**, javaee6/webservices/hello-jaxws2.2/**, javaee6/webservices/hello-singleton-ejb/**"
        excludes="build.xml,bp-project/test.xml,bp-project/build.properties.xyz,bp-project/test.properties,javaee6/docs/DeveloperREADME.html, javaee6/docs/DeveloperTroubleShooting.html, javaee6/docs/sample_doc_template.html,javaee6/docs/sdk_samples_index.html,javaee6/docs/UnitTesting.html,javaee6/**/test/**"/>

    <patternset id="exclude.installer.license"
        excludes="javaee6/LICENSE"/>

    <target name="package-sdk" depends="init-dist"
        description="packages the samples into a single jar for SDK">
        <mkdir dir="${dist.dir}"/>
	<antcall target="check-out-legal"/>
        <copy file="javaee6/docs/sdk_samples_index.html" tofile="${dist.dir}/index.html"/>
        <move failonerror="false" file="bp-project/build.properties" tofile="bp-project/build.properties.xyz" />
        <copy file="bp-project/build.properties.sample" tofile="bp-project/build.properties"/>
        <zip destfile="${dist.dir}/${release.dirname}.jar">
            <zipfileset dir="${dist.dir}" 
                includes="index.html,javaee6/**"/>
            <zipfileset dir="."> 
                <patternset refid="include.sdk.contents"/>
                <patternset refid="exclude.installer.license"/>
            </zipfileset>
        </zip>
        <delete file="${dist.dir}/index.html"/>
        <delete dir="${dist.dir}/javaee6"/>
        <move failonerror="false" file="bp-project/build.properties.xyz" tofile="bp-project/build.properties" />
    </target>

    <target name="package-profiles" depends="init-dist"
        description="creates packages for bp-project, web-profile and classic-profile">
        <mkdir dir="${dist.dir}"/>
	<antcall target="package-bp"/>
	<antcall target="package-web"/>
	<antcall target="package-classic"/>
    </target>

    <target name="package-bp" 
        description="packages the bp-project into a single jar">
        <move failonerror="false" file="bp-project/build.properties" tofile="bp-project/build.properties.xyz" />
        <copy file="bp-project/build.properties.sample" tofile="bp-project/build.properties"/>
        <zip destfile="${dist.dir}/${release.dirname}-bp-project.jar">
            <zipfileset dir="."> 
                <patternset refid="bp.project.contents"/>
            </zipfileset>
        </zip>
        <move failonerror="false" file="bp-project/build.properties.xyz" tofile="bp-project/build.properties" />
    </target>

    <target name="package-web"
        description="packages the web-profile samples into a single jar for SDK">
        <zip destfile="${dist.dir}/${release.dirname}-web-profile.jar">
            <zipfileset dir="."> 
                <patternset refid="web.profile.contents"/>
            </zipfileset>
        </zip>
    </target>

    <target name="package-classic"
        description="packages the classic-profile samples into a single jar for SDK">
        <zip destfile="${dist.dir}/${release.dirname}-classic-profile.jar">
            <zipfileset dir="."> 
                <patternset refid="classic.profile.contents"/>
            </zipfileset>
        </zip>
    </target>

    <target name="package-installer"
        description="packages the samples into a single jar for installer">
        <move failonerror="false" file="bp-project/build.properties" tofile="bp-project/build.properties.xyz" />
        <copy file="bp-project/build.properties.sample" tofile="bp-project/build.properties"/>
        <zip destfile="${dist.dir}/${release.dirname}.gf.jar">
            <zipfileset dir="."> 
                <patternset refid="include.sdk.contents"/>
            </zipfileset>
        </zip>
        <move failonerror="false" file="bp-project/build.properties.xyz" tofile="bp-project/build.properties" />
    </target>

    <target name="clean"
        description="cleans workspace by removing temporary directories like dist">
        <delete dir="${dist.dir}"/>
        <delete dir="${test.results.dir}"/>
    </target>

    <path id="samples-test-list">
        <filelist dir="javaee6/connectors/apps/mailconnector/mailconnector-ear/test" files="build.xml"/>
        <filelist dir="javaee6/connectors/apps/mailconnector/mailconnector-ra/test" files="build.xml"/>
        <filelist dir="javaee6/ejb/automatic-timer/test" files="build.xml"/>
        <filelist dir="javaee6/ejb/ejb31-war/test" files="build.xml"/>
        <filelist dir="javaee6/ejb/hello-stateless-ejb/test" files="build.xml"/>
        <filelist dir="javaee6/jpa/locking/test" files="build.xml"/>
        <filelist dir="javaee6/rest/message-board-war/test" files="build.xml"/>
        <filelist dir="javaee6/security/http-method-omission/test" files="build.xml"/>
        <filelist dir="javaee6/security/programmatic-login/test" files="build.xml"/>
        <filelist dir="javaee6/security/web-security-annotation/test" files="build.xml"/>
        <filelist dir="javaee6/web/jsf/basic-ajax/test" files="build.xml"/>
        <filelist dir="javaee6/web/jsf/basic-ezcomp/test" files="build.xml"/>
        <filelist dir="javaee6/web/jsf/scrumtoys/test" files="build.xml"/>
        <filelist dir="javaee6/web/servlet/annotation-war/test" files="build.xml"/>
        <filelist dir="javaee6/web/servlet/async-request-war/test" files="build.xml"/>
        <filelist dir="javaee6/web/servlet/dynamicregistration-war/test" files="build.xml"/>
        <filelist dir="javaee6/webservices/hello-jaxws2.2/test" files="build.xml"/>
        <filelist dir="javaee6/webservices/hello-singleton-ejb/test" files="build.xml"/>
    </path>

    <macrodef name="iterate-tests">
        <attribute name="target"/>
        <sequential>
            <subant target="@{target}" failonerror="false">
                <buildpath refid="samples-test-list"/>
            </subant>
        </sequential>
    </macrodef>

    <target name="runtest" depends="init-test">
	<tstamp/>
	<!--property name="results.file" value="${test.results.dir}/${DSTAMP}_${TSTAMP}_test_results.txt"/-->
	<property name="results.file" value="${test.results.dir}/test_results.txt"/>
	<record name="${results.file}" action="start" loglevel="info"/>
	<iterate-tests target="runtest"/>
	<record name="${results.file}" action="stop"/>
    </target>

    <target name="check-out-legal">
        <exec dir="${dist.dir}" executable="cvs">
            <arg line="co samples/javaee5/legal"/>
        </exec>
	<move todir="${dist.dir}/javaee5/legal">
	    <fileset dir="${dist.dir}/samples/javaee5/legal">
                <include name="**/*.txt"/>
                <include name="**/*.pdf"/>
	    </fileset>
	</move>
        <delete dir="${dist.dir}/samples"/>
    </target>

    <target name="all">
	<antcall target="set-perm-size"/>
	<antcall target="start-domain"/>
	<antcall target="start-db"/>
	<echo message="Build and run every sample"/>
	<subant target="-pre-setup">
	    <fileset dir="." includes="javaee6/build.xml"/>
	</subant>
	<subant target="all">
	    <fileset dir="." includes="javaee6/build.xml"/>
	</subant>
	<echo message="Unit testing"/>
	<antcall target="runtest"/>
	<subant target="-post-unsetup">
	    <fileset dir="." includes="javaee6/build.xml"/>
	</subant>
	<subant target="clean">
	    <fileset dir="." includes="javaee6/build.xml"/>
	</subant>
	<echo message="Packaging jar for staging"/>
	<antcall target="package-sdk"/>
	<antcall target="create-installer"/>
	<antcall target="stop-db"/>
	<antcall target="stop-domain"/>
    </target>

    <!-- build installer -->
    <taskdef name="installerBuilder" 
        classname="com.sun.tools.xjc.installer.builder.BuilderTask">
        <classpath>
            <fileset dir="${poormans.installer.home}" includes="*.jar"/>
        </classpath>
    </taskdef>

    <target name="create-installer" depends="package-installer">
        <!-- generate manifest.mf -->
        <property name="manifest.file" value="${dist.dir}/manifest.mf"/>
        <!-- do not format the following echo which is intentional -->
        <echo file="${manifest.file}" append="false">Main-Class: glassfish_samples_project</echo>
        <installerBuilder
            classFile="${dist.dir}/classes/glassfish_samples_project.class"
            licenseFile="javaee5/LICENSE"
            zipFile="${dist.dir}/${release.dirname}.gf.jar"/>
        <jar jarfile="${dist.dir}/${release.dirname}-installer.jar" 
            basedir="${dist.dir}/classes" manifest ="${manifest.file}"/>
        <delete file="${dist.dir}/${release.dirname}.gf.jar"/>
        <delete dir="${dist.dir}/classes"/>
        <delete file="${manifest.file}"/>
    </target>

    <target name="initialize.maven">
        <get
           src="http://apache.hoxt.com/maven/binaries/maven-ant-tasks-2.0.9.jar"
           dest="${dist.dir}/maven-ant-tasks-2.0.9.jar"
           verbose="true"
           usetimestamp="true"/>
        <path id="maven-ant-tasks.classpath" path="${dist.dir}/maven-ant-tasks-2.0.9.jar" />
        <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant"
                 classpathref="maven-ant-tasks.classpath" />
        <artifact:install-provider artifactId="wagon-svn" groupId="org.jvnet.wagon-svn" version="1.7">
        <artifact:remoteRepository id="java.net.maven2.repository" url="http://download.java.net/maven/2/" />
        <artifact:localRepository path="${maven.repo.local}"/>
        </artifact:install-provider>
    </target>

    <target name="create.pom.file" if="artifact">
        <copy file="samples_template.pom" tofile="${dist.dir}/pom-${artifact}.xml" overwrite="true">
            <filterset>
                <filter token="ARTIFACT_ID" value="${artifact}"/>
                <filter token="VERSION" value="${release.version}"/>
                <filter token="REPOSITORY_ID" value="java.net-maven2-repository"/>
                <filter token="REPOSITORY_URL" value="java-net:/maven2-repository/trunk/repository/"/>
            </filterset>
        </copy>
    </target>

    <target name="upload.maven" depends="initialize.maven" description="Publish samples to Maven2 repository">
        <echo message="release.version ${release.version}"/>

        <antcall target="create.pom.file" >
           <param name="artifact" value="bp-project"/>
        </antcall>
        <artifact:deploy file="${dist.dir}/${release.dirname}-bp-project.jar" uniqueVersion="false" >
            <pom file="${dist.dir}/pom-bp-project.xml"/>
        </artifact:deploy>
        <antcall target="create.pom.file" >
           <param name="artifact" value="web-profile"/>
        </antcall>
        <artifact:deploy file="${dist.dir}/${release.dirname}-web-profile.jar" uniqueVersion="false">
            <pom file="${dist.dir}/pom-web-profile.xml"/>
        </artifact:deploy>

        <antcall target="create.pom.file" >
           <param name="artifact" value="classic-profile"/>
        </antcall>
        <artifact:deploy file="${dist.dir}/${release.dirname}-classic-profile.jar" uniqueVersion="false">
            <pom file="${dist.dir}/pom-classic-profile.xml"/>
        </artifact:deploy>
    </target>

</project>
